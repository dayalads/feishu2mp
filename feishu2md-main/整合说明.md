# 模块整合说明

## 整合完成

已成功将模块 A（飞书文档 → Markdown）和模块 B（Markdown → 微信公众号 HTML）整合在一起。

## 新增功能

### 1. 核心转换器 (`core/wechat_html.go`)
- 将 Markdown HTML 转换为微信公众号格式
- 所有样式都是内联的（inline style）
- 不使用 style/link/script 标签
- 移除 class 和 id 属性
- 图片支持 base64 data URI 和 HTTPS URL

### 2. 转换接口 (`web/convert_handler.go`)
- 处理完整的转换流程：飞书文档 → Markdown → 微信公众号 HTML
- 自动下载图片并转换为 data URI
- 返回纯 HTML 文本，可直接复制粘贴

### 3. API 端点
- **`GET /convert`** - 一键转换接口

## 使用方法

### 后端服务

1. **启动服务**
   ```bash
   cd feishu2md-main/web
   go run .
   ```

2. **调用接口**
   ```
   GET http://localhost:8080/convert?url=<飞书文档URL>&app_id=<APP_ID>&app_secret=<APP_SECRET>
   ```

### 前端调用示例

由于 `popup.js` 是打包后的代码，如果需要在浏览器插件中调用新接口，可以在插件代码中添加以下逻辑：

```javascript
// 在 popup.js 或相关脚本中添加
async function convertToWeChatHTML(feishuURL, appId, appSecret) {
  try {
    const encodedURL = encodeURIComponent(feishuURL);
    const apiURL = `http://localhost:8080/convert?url=${encodedURL}&app_id=${appId}&app_secret=${appSecret}`;
    
    const response = await fetch(apiURL);
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const html = await response.text();
    
    // 复制到剪贴板
    await navigator.clipboard.writeText(html);
    
    return {
      success: true,
      html: html
    };
  } catch (error) {
    console.error('转换失败:', error);
    return {
      success: false,
      error: error.message
    };
  }
}
```

## API 接口说明

### `/convert` 接口

**请求方式**: GET

**参数**:
- `url` (必需) - 飞书文档 URL（需要 URL 编码）
- `app_id` (可选) - 飞书 APP ID（也可通过环境变量 `FEISHU_APP_ID` 提供）
- `app_secret` (可选) - 飞书 APP Secret（也可通过环境变量 `FEISHU_APP_SECRET` 提供）

**响应**:
- Content-Type: `text/html; charset=utf-8`
- 返回纯 HTML 文本，所有样式都是内联的

**示例请求**:
```bash
curl "http://localhost:8080/convert?url=https%3A%2F%2Fexample.feishu.cn%2Fdocx%2Fxxx&app_id=your_app_id&app_secret=your_app_secret"
```

**示例响应**:
```html
<p style="margin: 12px 0; text-align: justify; word-wrap: break-word; word-break: break-all; line-height: 1.8; font-size: 17px; color: #333333;">内容</p>
<h1 style="font-size: 24px; font-weight: bold; line-height: 1.4; margin: 20px 0 15px; padding-bottom: 10px; border-bottom: 2px solid #eaeaea; color: #333333;">标题</h1>
```

## 关键特性

✅ **完整流程整合**
- 一个接口完成：飞书文档 → Markdown → 微信公众号 HTML

✅ **纯内联样式**
- 不使用 style/link/script 标签
- 所有样式都是内联的
- 不使用 class 或 id

✅ **图片处理**
- 小图片（< 500KB）：使用 data URI（base64）
- 大图片（≥ 500KB）：也使用 data URI（临时方案）
- 生产环境建议配置图床服务

✅ **公众号兼容**
- 只使用公众号白名单标签
- 样式设计符合公众号阅读习惯
- 可直接复制粘贴到公众号编辑器

## 文件结构

```
feishu2md-main/
├── core/
│   ├── wechat_html.go          # 新增：微信公众号 HTML 转换器
│   ├── parser.go                # 原有：Markdown 解析器
│   └── ...
├── web/
│   ├── convert_handler.go      # 新增：转换接口处理器
│   ├── download.go              # 原有：下载处理器
│   ├── main.go                  # 更新：添加 /convert 路由
│   └── ...
└── ...
```

## 样式说明

转换后的 HTML 包含以下元素的专门样式：

- **段落 (p)**: 17px 字号，1.8 行高，两端对齐
- **标题 (h1-h6)**: 24px-16px 字号，带底边框
- **列表 (ul/ol/li)**: 合适的间距和缩进
- **代码块 (pre/code)**: 灰色背景，等宽字体
- **引用 (blockquote)**: 左边框，灰色背景
- **图片 (img)**: 自适应宽度，居中显示
- **链接 (a)**: 蓝色文字，底边框
- **表格 (table)**: 完整边框样式

## 注意事项

1. **图片大小限制**
   - 微信公众号对 data URI 有大小限制
   - 建议大图片使用图床服务（配置 `IMAGE_SERVICE_URL` 环境变量）

2. **样式兼容性**
   - 公众号编辑器可能会过滤某些样式
   - 如遇到问题，可以根据实际情况调整样式

3. **浏览器插件**
   - 如果 `popup.js` 是打包后的代码，需要在构建时添加调用 `/convert` 的逻辑
   - 或者在运行时通过 Chrome Extension API 调用

4. **CORS 支持**
   - 服务已启用 CORS，允许浏览器扩展访问

## 后续优化建议

1. **图床集成**
   - 实现图片上传到图床服务的逻辑
   - 支持多种图床服务（七牛云、阿里云OSS等）

2. **缓存机制**
   - 对转换结果进行缓存
   - 减少重复转换的开销

3. **错误处理**
   - 增强错误处理和提示
   - 提供更详细的错误信息

4. **批量处理**
   - 支持批量转换多个文档
   - 提供批量 API 端点



